<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dtstack.engine.service.db.mapper.RdosEngineJobStopRecordMapper">

    <resultMap id="rdosEngineJobStopRecord"
               type="com.dtstack.engine.service.db.dataobject.RdosEngineJobStopRecord">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="gmt_create" property="gmtCreate" jdbcType="TIMESTAMP"/>
        <result column="gmt_modified" property="gmtModified" jdbcType="TIMESTAMP"/>
        <result column="is_deleted" property="isDeleted" jdbcType="INTEGER"/>
        <result column="task_id" property="taskId" jdbcType="VARCHAR"/>
        <result column="task_type" property="taskType" jdbcType="INTEGER"/>
        <result column="engine_type" property="engineType" jdbcType="VARCHAR"/>
        <result column="compute_type" property="computeType" jdbcType="INTEGER"/>
        <result column="group_name" property="groupName" jdbcType="VARCHAR"/>
        <result column="version" property="version" jdbcType="VARCHAR"/>
    </resultMap>

    <insert id="insert" parameterType="com.dtstack.engine.service.db.dataobject.RdosEngineJobStopRecord">
        insert into rdos_engine_job_stop_record(task_id, task_type, engine_type, compute_type, group_name)
        values(#{taskId}, #{taskType}, #{engineType}, #{computeType}, #{groupName})
        <selectKey resultType="long" keyProperty="id" order="AFTER">
            SELECT LAST_INSERT_ID() AS ID
        </selectKey>
    </insert>

    <update id="delete" parameterType="java.util.HashMap">
        update rdos_engine_job_stop_record set gmt_modified = now(), is_deleted = 1 where id = #{id}
    </update>

    <update id="updateVersion" parameterType="java.util.HashMap">
        update rdos_engine_job_stop_record set version = version + 1, gmt_modified = now() where id = #{id} and version = #{version}
    </update>

    <select id="listStopJob" parameterType="java.util.HashMap" resultMap="rdosEngineJobStopRecord">
        select id,task_id,task_type,engine_type,compute_type,group_name,version,gmt_create,gmt_modified,is_deleted
        from rdos_engine_job_stop_record where id > #{startId} and is_deleted =0 and version = 0
        order by id asc limit 100;
    </select>

    <update id="resetRecord" parameterType="java.util.HashMap">
        update rdos_engine_job_stop_record set version = 0, gmt_modified = now() where id = #{id} and is_deleted =0
    </update>

    <select id="listByJobIds" parameterType="java.util.HashMap" resultType="java.lang.String">
        select task_id as jobId
        from rdos_engine_job_stop_record
        where task_id in
        <foreach item="jobId" index="index" collection="jobIds" open="(" separator="," close=")">
            #{jobId}
        </foreach>
        and is_deleted =0;
    </select>

</mapper>
